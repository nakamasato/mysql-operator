name: e2e
on:
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest
    env:
      KREW_VERSION: v0.3.3
    steps:
      - uses: actions/checkout@master

      - uses: engineerd/setup-kind@v0.5.0
        with:
          version: "v0.11.1"

      - name: Test kind
        run: |
          kubectl cluster-info
          kubectl get pods -n kube-system
          echo "current-context:" $(kubectl config current-context)
          echo "environment-kubeconfig:" ${KUBECONFIG}

      - name: Install krew
        run: |
          set -euo pipefail
          cd "$(mktemp -d)"
          curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/download/${KREW_VERSION}/krew.{tar.gz,yaml}"
          tar zxvf krew.tar.gz
          ./krew-linux_amd64 install --manifest=krew.yaml --archive=krew.tar.gz

      - name: Install kuttl
        run: kubectl krew install kuttl

      - name: e2e
        run: kubectl kuttl test
